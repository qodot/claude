---
allowed-tools: Bash(git:*), Bash(gh:*), Read(*), Write(*), Edit(*), Grep(*), Glob(*), TodoWrite(*), AskUserQuestion(*), SlashCommand(/commit), SlashCommand(/pr)
description: 브랜치 생성, 계획, 구현을 포함한 새 기능 개발 프로세스 시작 (완전 자동화)
argument-hint: [--base=<branch>]
---

# 기능 개발 워크플로우

## 역할

당신은 **수석 소프트웨어 엔지니어링 리드**입니다:
- 기능 개발 라이프사이클 전체를 자동화
- Git 워크플로우 및 TDD 적용
- 계획 수립부터 PR 생성까지 완전 자동 처리

## 핵심 원칙

- 5개 질문으로 정보 수집 (AskUserQuestion 도구 활용)
- 각 TODO 완료 시 자동 커밋 (`/commit` 실행)
- 모든 TODO 완료 후 자동 PR 생성 (`/pr --draft`)
- Git 저장소가 아니면 즉시 중단
- 커밋되지 않은 변경사항 있으면 사용자 승인 필요

## 옵션

- `--base=<branch>`: 베이스 브랜치 지정 (기본값: 자동 감지)

---

## 프로세스

### 1단계: 환경 검증 [1/8]

```bash
# Git 저장소 확인
git status || { echo "ERROR: Not a git repository"; exit 1; }

# 프로젝트 이름 추출
PROJECT_NAME=$(basename "$(pwd)")

# 베이스 브랜치 결정 (우선순위: --base 옵션 > 자동 감지)
# 자동 감지: main > master > develop 순으로 존재하는 브랜치 사용
if [ -n "$BASE_OPTION" ]; then
  BASE_BRANCH="$BASE_OPTION"
elif git show-ref --verify --quiet refs/heads/main; then
  BASE_BRANCH="main"
elif git show-ref --verify --quiet refs/heads/master; then
  BASE_BRANCH="master"
elif git show-ref --verify --quiet refs/heads/develop; then
  BASE_BRANCH="develop"
else
  # 원격 기본 브랜치 확인
  BASE_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
fi
```

**커밋되지 않은 변경사항 확인**:
- dirty 상태면 AskUserQuestion으로 사용자 승인 요청
- 승인 없으면 중단

**중단 요청 처리**:
- 사용자가 "중단", "취소", "stop" 입력 시 즉시 워크플로우 종료
- 생성된 브랜치가 있으면 삭제 여부 확인

### 2단계: 정보 수집 [2/8]

**시작 메시지**:
```
========================================
FEATURE DEVELOPMENT WORKFLOW
Project: <PROJECT_NAME>
Base branch: <BASE_BRANCH>
========================================
```

**AskUserQuestion 도구로 5개 질문 수집** (한 번에 최대 4개씩):

**첫 번째 호출 (질문 1-4)**:
- 질문 1: PR 제목 (필수) - PR 제목을 한 줄로 작성
- 질문 2: 기능 설명 (선택) - 1-2문장으로 간단히 설명
- 질문 3: 배경 및 이유 (필수) - 해결하려는 문제, 이슈 번호(SPR-XXX), 제공 가치
- 질문 4: 작업 내용 (필수) - 추가/수정될 기능, 제외할 사항

**두 번째 호출 (질문 5)**:
- 질문 5: 테스트 및 검증 (필수) - 테스트 시나리오, Breaking changes, 성능/보안 고려사항

**자동 처리**:
- PR 제목에서 kebab-case 브랜치 이름 자동 생성
- 배경에서 이슈 번호(SPR-XXX) 자동 추출

**최종 확인**:
- 수집된 정보 요약 표시
- AskUserQuestion으로 확인: "진행" / "다시 입력" / "중단"

### 3단계: 브랜치 생성 [3/8]

```bash
# 베이스 브랜치 업데이트
git checkout "$BASE_BRANCH" && git pull origin "$BASE_BRANCH"

# Git username 확인
GIT_USERNAME=$(git config user.name | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g')
[ -z "$GIT_USERNAME" ] && GIT_USERNAME="developer"

# 브랜치 이름 생성
# 규칙: {git-username}/{project-name}/{issue-number|branch-name}
if [ -n "$ISSUE_NUMBER" ]; then
  BRANCH="${GIT_USERNAME}/${PROJECT_NAME}/${ISSUE_NUMBER}"
else
  BRANCH="${GIT_USERNAME}/${PROJECT_NAME}/${BRANCH_NAME}"
fi

# 기존 브랜치 존재 여부 확인
if git show-ref --verify --quiet "refs/heads/$BRANCH"; then
  # 로컬에 존재하면 사용자에게 확인
  # 옵션: "기존 브랜치 사용" / "새 이름으로 생성" / "중단"
fi

if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
  # 원격에 존재하면 사용자에게 확인
  # 옵션: "원격 브랜치 체크아웃" / "새 이름으로 생성" / "중단"
fi

# 브랜치 생성 및 푸시
git checkout -b "$BRANCH"
git push -u origin "$BRANCH"
```

### 4단계: 계획 저장 [4/8]

```bash
# 브랜치 이름의 슬래시를 언더스코어로 치환하여 디렉토리 경로 생성
SAFE_BRANCH_NAME=$(echo "$BRANCH" | tr '/' '_')
PLAN_DIR=".claude/features/${SAFE_BRANCH_NAME}"
```

`${PLAN_DIR}/plan.yml` 생성:

```yaml
feature_name: <브랜치 이름>
project_name: <프로젝트 이름>
base_branch: <베이스 브랜치>
description: <질문2 답변>
created_at: <타임스탬프>

pr_info:
  title: "<질문1 답변>"
  link: null

background:
  why: |
    <질문3 답변>
  issue: "<이슈 번호>"

changes:
  what: |
    <질문4 답변>
  includes: []
  excludes: []

testing:
  scenarios: []
  breaking_changes: false
  notes: |
    <질문5 답변>
```

### 5단계: TODO 리스트 초기화 [5/8]

**질문 답변 기반으로 TODO 동적 생성**:

TodoWrite로 항목 생성 (기본 템플릿 + 질문4 작업 내용 기반 세분화):

**기본 항목**:
1. "브랜치 및 개발 환경 설정" -> 즉시 완료
2. "테스트 파일 생성 및 초기 테스트 케이스 작성" -> in_progress

**질문4 기반 동적 항목**:
- 질문4에서 언급된 각 작업 항목을 개별 TODO로 분해
- 예: "API 추가, 모델 수정, 서비스 레이어 구현" -> 3개의 TODO로 분리

**필수 마무리 항목**:
- "보안 취약점 점검" (입력 검증, 인증/인가, SQL injection, XSS 등)
- "테스트 실행 및 검증"
- "PR 생성 (/pr 실행)"

**TODO 생성 규칙**:
- 각 TODO는 구체적이고 검증 가능해야 함
- 하나의 TODO가 너무 크면 세분화
- 의존성 순서대로 배치

### 6단계: 자동 구현 [6/8]

**각 TODO마다**:
1. 구현 (테스트/코드/문서 작성)
2. **논리적 단위로 커밋 분리** (아래 규칙 참조)
3. TODO 완료 표시
4. 다음 TODO를 in_progress로 변경

**커밋 분리 규칙 (IMPORTANT)**:

커밋은 리뷰하기 쉽도록 **논리적 단위로 분리**해야 합니다:

1. **서비스/모듈 추가**: 새로운 서비스나 모듈은 별도 커밋
   - 예: "CampaignCreatorCSVExporter 서비스 레이어 추가"

2. **API 수정**: 각 API 엔드포인트 수정은 별도 커밋
   - 예: "캠페인 크리에이터 다운로드 API에 Timezone 헤더 적용"

3. **테스트 코드**:
   - 새 기능의 테스트는 해당 기능과 같은 커밋에 포함
   - 테스트 파일 이동/삭제는 별도 커밋

4. **리팩토링**: 기능 변경과 리팩토링은 분리
   - 예: 기존 코드 삭제는 별도 커밋

**하나의 커밋에 모든 변경사항을 넣지 마세요!**

**커밋 prefix 규칙**:
- DB 마이그레이션: `migrate:`
- AI 지침/문서: `docs:`
- 그 외: prefix 없음

**금지된 prefix (NEVER USE)**:
- `feat:` - 사용 금지
- `fix:` - 사용 금지
- 기타 Conventional Commits prefix - 사용 금지

### 7단계: PR 생성 [7/8]

모든 TODO 완료 후:

```
========================================
IMPLEMENTATION COMPLETE
----------------------------------------
- All tests passed
- Code written
- Security review done
- Commits created

Creating PR automatically...
========================================
```

`/pr --draft --base=$BASE_BRANCH` 자동 실행:
- plan.yml에서 PR 제목/본문 생성
- Draft PR 생성
- plan.yml에 PR URL 기록
- 브라우저에서 PR 페이지 열기

### 8단계: 자체 검증 [8/8]

```bash
CURRENT_BRANCH=$(git branch --show-current)
PR_EXISTS=$(gh pr list --head "$CURRENT_BRANCH" --json number --jq '.[0].number')

if [ -z "$PR_EXISTS" ]; then
  echo "WARNING: PR not created, retrying..."
  # /pr --draft 재실행
fi
```

**최종 출력**:
```
========================================
WORKFLOW COMPLETE [8/8]

Commits: <N>
PR: https://github.com/user/repo/pull/<number>
Base: <BASE_BRANCH>

Next steps:
- Run local tests
- Mark as ready for review
- Assign reviewers
========================================
```

---

## 오류 처리

어떤 단계든 실패하면:
1. 즉시 중지하고 오류 보고
2. 무엇이 잘못되었는지 명확히 설명
3. 수정 방법 제안
4. 사용자에게 진행 방법 질문

## 성공 기준

- 5개 질문으로 핵심 정보 수집 (AskUserQuestion 활용)
- 베이스 브랜치 자동 감지 또는 옵션으로 지정
- 프로젝트/브랜치 이름 자동 생성
- 기존 브랜치 충돌 시 사용자 확인
- 질문 기반 동적 TODO 생성
- 테스트 구조 자동 설정 (TDD)
- 보안 취약점 점검 완료
- 논리적 단위로 자동 커밋 (feat:/fix: prefix 금지)
- Draft PR 자동 생성
- 각 단계별 진행률 표시 [N/8]
